<!doctype html>
<html>
  <head>
    <title>Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <style>
      body { margin: 0; background: #1e1e1e; height: 100vh; overflow: hidden; }
      #terminal { height: 100%; width: 100%; }
    </style>
  </head>
  <body>
    <div id="terminal"></div>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script>
      // Initialize Terminal
      const term = new Terminal({
        cursorBlink: true,
        fontFamily: 'Menlo, Consolas, monospace',
        theme: { background: "#1e1e1e" }
      });
      const fitAddon = new FitAddon.FitAddon();
      term.loadAddon(fitAddon);
      term.open(document.getElementById("terminal"));
      fitAddon.fit();

      // Connect
      // Grab the token from the current URL to pass to the WebSocket connection
      const params = new URLSearchParams(window.location.search);
      const token = params.get("token") || "";
      const wsProtocol = location.protocol === "https:" ? "wss://" : "ws://";
      const wsUrl = `${wsProtocol}${location.host}/terminal?token=${token}`;

      const socket = new WebSocket(wsUrl);

      // 1. HANDLE INPUT (Send as JSON)
      term.onData((data) => {
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({ type: "input", data: data }));
        }
      });

      // 2. HANDLE RESIZE (Send as JSON)
      function onResize() {
        fitAddon.fit();
        if (socket.readyState === WebSocket.OPEN) {
          const { cols, rows } = term;
          socket.send(JSON.stringify({ type: "resize", cols, rows }));
        }
      }
      window.addEventListener("resize", onResize);

      // 3. HANDLE INCOMING DATA (Raw Text)
      socket.onmessage = (event) => {
        term.write(event.data);
      };

      socket.onopen = () => {
        term.write("\x1b[32mConnected via Cloudflare Workers.\x1b[0m\r\n");
        onResize(); // Sync initial size
      };
      
      socket.onclose = () => term.write("\r\n\x1b[31mConnection closed.\x1b[0m");
    </script>
  </body>
</html>
